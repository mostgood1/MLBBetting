<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Analysis - MLB-Betting</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #4fd1c7;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn.active {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
            transform: translateY(-2px);
        }

        .btn {
            background: linear-gradient(45deg, #4fd1c7, #5f9ea0);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 209, 199, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #6a5acd, #9370db);
        }

        .btn.home {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            margin-right: auto; /* Push to left if in flex container */
        }

        .btn.home:hover {
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .date-input {
            padding: 12px;
            border: 2px solid #4fd1c7;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            border-left: 4px solid #4fd1c7;
        }

        .recap-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .recap-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #4fd1c7;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4fd1c7;
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-teams {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .away-team, .home-team {
            color: #4fd1c7;
        }

        .versus {
            color: #fff;
            margin: 0 8px;
        }

        .final-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .game-time {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .prediction-section, .performance-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .prediction-section h4, .performance-section h4 {
            margin-bottom: 10px;
            color: #4fd1c7;
        }

        .prediction-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .prediction-label {
            opacity: 0.8;
        }

        .prediction-value {
            font-weight: bold;
        }

        .winner-pred.correct {
            color: #4ade80;
        }

        .winner-pred.incorrect {
            color: #f87171;
        }

        .performance-grade {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .grade-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        .grade-aplus, .grade-a { background: linear-gradient(45deg, #4ade80, #22c55e); }
        .grade-aminus, .grade-bplus { background: linear-gradient(45deg, #a3e635, #84cc16); }
        .grade-b, .grade-bminus { background: linear-gradient(45deg, #facc15, #eab308); }
        .grade-cplus, .grade-c { background: linear-gradient(45deg, #fb923c, #f97316); }
        .grade-cminus, .grade-dplus { background: linear-gradient(45deg, #f87171, #ef4444); }
        .grade-d, .grade-dminus, .grade-f { background: linear-gradient(45deg, #dc2626, #b91c1c); }

        .grade-letter {
            font-size: 1.2rem;
        }

        .grade-percentage {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .performance-details {
            margin-top: 10px;
        }

        .performance-details p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .error {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* System Performance Analytics Styles */
        .system-performance {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(79, 209, 199, 0.1), rgba(79, 209, 199, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(79, 209, 199, 0.2);
        }

        .system-performance h3 {
            color: #4fd1c7;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-group h4 {
            color: #4fd1c7;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }

        .metric-stats {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .metric-item {
            text-align: center;
            flex: 1;
        }

        .metric-item.large {
            flex: 2;
        }

        .metric-value {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .metric-value.grade-display {
            font-size: 2rem;
            color: #4fd1c7;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            color: #b0b0b0;
        }

        .grade-distribution {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .grade-distribution h4 {
            color: #4fd1c7;
            margin-bottom: 15px;
            text-align: center;
        }

        .grade-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            text-align: center;
        }

        .grade-bar {
            background: rgba(79, 209, 199, 0.3);
            border-radius: 4px;
            padding: 8px 4px;
            position: relative;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grade-bar.has-games {
            background: linear-gradient(to top, #4fd1c7, rgba(79, 209, 199, 0.7));
        }

        .grade-label {
            font-weight: bold;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .grade-count {
            font-size: 0.8rem;
            opacity: 0.9;
            color: #ffffff;
        }

        /* Comprehensive Betting Performance Styles */
        .comprehensive-betting-performance {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 107, 107, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(255, 107, 107, 0.2);
        }

        .comprehensive-betting-performance h3 {
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
        }

        .betting-type-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .tab-button.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }

        .betting-type-section {
            display: none;
        }

        .betting-type-section.active {
            display: block;
        }

        .betting-type-section h4 {
            color: #ff6b6b;
            margin-bottom: 15px;
            text-align: center;
        }

        .betting-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .betting-metrics .metric-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .betting-metrics .metric-group h5 {
            color: #ff6b6b;
            margin-bottom: 15px;
            font-size: 1rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .games-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .betting-type-tabs {
                flex-direction: column;
                gap: 5px;
            }
            
            .tab-button {
                text-align: center;
            }
            
            .betting-metrics {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .tab-button {
                font-size: 0.8rem;
                padding: 8px 12px;
            }
            
            .comprehensive-betting-performance {
                margin: 15px 0;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            {% if filter_type == 'winners' %}
            <h1>🎯 Winner Predictions History</h1>
            <p>All games where we correctly predicted the winning team</p>
            {% elif filter_type == 'totals' %}
            <h1>📊 Total Predictions History</h1>
            <p>All games where we correctly predicted over/under totals</p>
            {% elif filter_type == 'perfect' %}
            <h1>💎 Perfect Game Predictions</h1>
            <p>Games where we correctly predicted both winner and total</p>
            {% else %}
            <h1>🏆 Historical Analysis</h1>
            <p>Performance tracking and prediction accuracy analysis</p>
            {% endif %}
        </div>

        <div class="controls">
            <a href="/" class="btn home">🏠 Back to Today's Games</a>
            <div class="filter-controls">
                <a href="/historical?filter=all" class="btn {% if filter_type == 'all' %}active{% endif %}">📊 All Games</a>
                <a href="/historical?filter=winners" class="btn {% if filter_type == 'winners' %}active{% endif %}">🎯 Winners</a>
                <a href="/historical?filter=totals" class="btn {% if filter_type == 'totals' %}active{% endif %}">📈 Totals</a>
                <a href="/historical?filter=perfect" class="btn {% if filter_type == 'perfect' %}active{% endif %}">💎 Perfect</a>
            </div>
            <input type="date" id="analysis-date" class="date-input" />
            <button class="btn" onclick="loadAnalysis()">📊 Analyze Date</button>
            <button class="btn secondary" onclick="loadToday()">📅 Today</button>
        </div>

        <div id="status" class="status" style="display: none;">
            <div id="status-message"></div>
        </div>

        <div id="recap-section" class="recap-section" style="display: none;">
            <h2 class="recap-title">Performance Recap</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span id="total-games" class="stat-value">-</span>
                    <div class="stat-label">Total Games</div>
                </div>
                <div class="stat-item">
                    <span id="correct-predictions" class="stat-value">-</span>
                    <div class="stat-label">Correct Predictions</div>
                </div>
                <div class="stat-item">
                    <span id="accuracy-rate" class="stat-value">-</span>
                    <div class="stat-label">Accuracy Rate</div>
                </div>
                <div class="stat-item">
                    <span id="average-grade" class="stat-value">-</span>
                    <div class="stat-label">Average Grade</div>
                </div>
                <div class="stat-item">
                    <span id="best-predictions" class="stat-value">-</span>
                    <div class="stat-label">A+ Predictions</div>
                </div>
            </div>
            
            <!-- System Performance Analytics Section -->
            <div id="system-performance" class="system-performance" style="display: none;">
                <h3>🎯 System Performance Analytics</h3>
                <div class="performance-metrics">
                    <div class="metric-group">
                        <h4>Winner Predictions</h4>
                        <div class="metric-stats">
                            <div class="metric-item">
                                <span id="winner-accuracy" class="metric-value">-</span>
                                <div class="metric-label">Overall Accuracy</div>
                            </div>
                            <div class="metric-item">
                                <span id="high-confidence-accuracy" class="metric-value">-</span>
                                <div class="metric-label">High Confidence</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-group">
                        <h4>Score Predictions</h4>
                        <div class="metric-stats">
                            <div class="metric-item">
                                <span id="avg-score-diff" class="metric-value">-</span>
                                <div class="metric-label">Avg Score Diff</div>
                            </div>
                            <div class="metric-item">
                                <span id="total-runs-diff" class="metric-value">-</span>
                                <div class="metric-label">Total Runs Diff</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-group">
                        <h4>System Grade</h4>
                        <div class="metric-stats">
                            <div class="metric-item large">
                                <span id="system-grade" class="metric-value grade-display">-</span>
                                <div class="metric-label">Overall Rating</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="grade-distribution" class="grade-distribution">
                    <h4>Grade Distribution</h4>
                    <div id="grade-chart" class="grade-chart"></div>
                </div>
            </div>
            
            <!-- Comprehensive Betting Performance Section -->
            <div id="comprehensive-betting-performance" class="comprehensive-betting-performance" style="display: none;">
                <h3>🎯 Comprehensive Betting Performance</h3>
                
                <!-- Betting Type Tabs -->
                <div class="betting-type-tabs">
                    <button class="tab-button active" onclick="showBettingType('moneyline')">💰 Moneyline</button>
                    <button class="tab-button" onclick="showBettingType('totals')">📊 Totals</button>
                    <button class="tab-button" onclick="showBettingType('run_line')">⚾ Run Line</button>
                    <button class="tab-button" onclick="showBettingType('perfect_games')">💎 Perfect Games</button>
                </div>
                
                <!-- Moneyline Performance -->
                <div id="moneyline-performance" class="betting-type-section active">
                    <h4>💰 Moneyline Betting Performance</h4>
                    <div class="betting-metrics">
                        <div class="metric-group">
                            <h5>30-Day Performance</h5>
                            <div class="metric-stats">
                                <div class="metric-item">
                                    <span id="ml-total-bets" class="metric-value">-</span>
                                    <div class="metric-label">Total Bets</div>
                                </div>
                                <div class="metric-item">
                                    <span id="ml-win-rate" class="metric-value">-</span>
                                    <div class="metric-label">Win Rate</div>
                                </div>
                                <div class="metric-item">
                                    <span id="ml-roi" class="metric-value">-</span>
                                    <div class="metric-label">ROI</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-group">
                            <h5>Profitability</h5>
                            <div class="metric-stats">
                                <div class="metric-item">
                                    <span id="ml-total-profit" class="metric-value">-</span>
                                    <div class="metric-label">Net Profit</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Totals Performance -->
                <div id="totals-performance" class="betting-type-section">
                    <h4>📊 Over/Under Totals Performance</h4>
                    <div class="betting-metrics">
                        <div class="metric-group">
                            <h5>30-Day Performance</h5>
                            <div class="metric-stats">
                                <div class="metric-item">
                                    <span id="totals-total-bets" class="metric-value">-</span>
                                    <div class="metric-label">Total Bets</div>
                                </div>
                                <div class="metric-item">
                                    <span id="totals-win-rate" class="metric-value">-</span>
                                    <div class="metric-label">Win Rate</div>
                                </div>
                                <div class="metric-item">
                                    <span id="totals-roi" class="metric-value">-</span>
                                    <div class="metric-label">ROI</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-group">
                            <h5>Profitability</h5>
                            <div class="metric-stats">
                                <div class="metric-item">
                                    <span id="totals-total-profit" class="metric-value">-</span>
                                    <div class="metric-label">Net Profit</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Run Line Performance -->
                <div id="run_line-performance" class="betting-type-section">
                    <h4>⚾ Run Line Performance</h4>
                    <div class="betting-metrics">
                        <div class="metric-group">
                            <h5>30-Day Performance</h5>
                            <div class="metric-stats">
                                <div class="metric-item">
                                    <span id="rl-total-bets" class="metric-value">-</span>
                                    <div class="metric-label">Total Bets</div>
                                </div>
                                <div class="metric-item">
                                    <span id="rl-win-rate" class="metric-value">-</span>
                                    <div class="metric-label">Win Rate</div>
                                </div>
                                <div class="metric-item">
                                    <span id="rl-roi" class="metric-value">-</span>
                                    <div class="metric-label">ROI</div>
                                </div>
                            </div>
                        </div>
                        <div class="metric-group">
                            <h5>Profitability</h5>
                            <div class="metric-stats">
                                <div class="metric-item">
                                    <span id="rl-total-profit" class="metric-value">-</span>
                                    <div class="metric-label">Net Profit</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Perfect Games Performance -->
                <div id="perfect_games-performance" class="betting-type-section">
                    <h4>💎 Perfect Games Performance</h4>
                    <div class="betting-metrics">
                        <div class="metric-group">
                            <h5>Perfect Game Success</h5>
                            <div class="metric-stats">
                                <div class="metric-item">
                                    <span id="perfect-opportunities" class="metric-value">-</span>
                                    <div class="metric-label">Opportunities</div>
                                </div>
                                <div class="metric-item">
                                    <span id="perfect-hits" class="metric-value">-</span>
                                    <div class="metric-label">Perfect Hits</div>
                                </div>
                                <div class="metric-item">
                                    <span id="perfect-success-rate" class="metric-value">-</span>
                                    <div class="metric-label">Success Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="games-container">
            <div class="status" id="initial-loading">
                <div>🚀 Loading yesterday's analysis...</div>
                <div style="font-size: 0.8em; margin-top: 5px;" id="debug-info">Debug: Initializing...</div>
            </div>
        </div>
    </div>

    <script>
        // Set filter type from backend
        const FILTER_TYPE = '{{ filter_type or "all" }}';
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing with filter:', FILTER_TYPE);
            updateDebugInfo('Page loaded with filter: ' + FILTER_TYPE);
            
            // Always start by loading yesterday's data, then apply filters
            updateDebugInfo('Loading yesterday analysis and applying filter: ' + FILTER_TYPE);
            setTimeout(function() {
                loadToday();
            }, 100);
        });

        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            if (debugElement) {
                debugElement.textContent = 'Debug: ' + message;
            }
            console.log('DEBUG:', message);
        }

        function loadToday() {
            console.log('Loading recent completed games for historical analysis...');
            updateDebugInfo('loadToday() called - loading recent games with filter: ' + FILTER_TYPE);
            
            // For filters, load multiple dates to ensure we find matching games
            // For "all" mode, just load yesterday as before
            if (FILTER_TYPE !== 'all') {
                updateDebugInfo('Filter mode: loading multiple dates to find ' + FILTER_TYPE + ' games');
                loadMultipleDatesForFilter();
            } else {
                // Get yesterday's date as before for "all" mode
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                
                const year = yesterday.getFullYear();
                const month = yesterday.getMonth() + 1;
                const day = yesterday.getDate();
                
                const monthStr = month < 10 ? '0' + month : month.toString();
                const dayStr = day < 10 ? '0' + day : day.toString();
                const targetDate = year + '-' + monthStr + '-' + dayStr;
                updateDebugInfo('All games mode: loading yesterday: ' + targetDate);
                
                console.log('Target date calculated as:', targetDate);
                updateDebugInfo('Target date: ' + targetDate + ', calling loadAnalysis()...');
                
                document.getElementById('analysis-date').value = targetDate;
                loadAnalysis();
            }
        }

        // Load betting accuracy data for filtering - same as main page
        function loadBettingAccuracyData() {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/data/betting_accuracy_analysis.json', true);
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            resolve(data);
                        } catch (e) {
                            console.error('Error parsing betting accuracy data:', e);
                            reject(e);
                        }
                    } else {
                        console.log('Betting accuracy data not available');
                        resolve(null);
                    }
                };
                xhr.onerror = function() {
                    console.log('Failed to load betting accuracy data');
                    resolve(null);
                };
                xhr.send();
            });
        }

        function showError(message) {
            const container = document.getElementById('games-container');
            container.innerHTML = `
                <div class="status" style="color: #ff6b6b;">
                    <h3>❌ ${message}</h3>
                    <p>Try selecting a different filter or refresh the page.</p>
                    <div style="margin-top: 15px;">
                        <a href="/historical?filter=all" class="btn" style="text-decoration: none; margin-right: 10px;">📊 View All Games</a>
                        <button class="btn secondary" onclick="location.reload()">🔄 Refresh</button>
                    </div>
                </div>
            `;
            hideStatus();
        }

        function loadMultipleDatesForFilter() {
            console.log('🔄 UPDATED SCRIPT LOADED - v2.1 Loading filtered games for:', FILTER_TYPE);
            showStatus('Loading ' + FILTER_TYPE + ' games from betting accuracy data...');
            
            // Use the new filtered API endpoint - much simpler!
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/historical-filtered/' + FILTER_TYPE, true);
            xhr.timeout = 10000; // 10 seconds timeout
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if (data.games && Array.isArray(data.games)) {
                                console.log(`✅ Found ${data.games.length} ${FILTER_TYPE} games`);
                                console.log('🔍 Sample game data:', data.games[0]);
                                updateDebugInfo(`✅ Loaded ${data.games.length} ${FILTER_TYPE} games from betting accuracy data`);
                                
                                // Convert the betting accuracy format to game format for display
                                const formattedGames = data.games.map(function(game) {
                                    console.log('🔧 Processing game:', game.away_team, '@', game.home_team, game.date);
                                    // Parse predicted score
                                    const predictedScoreParts = game.predicted_score.split('-');
                                    const predAwayScore = parseFloat(predictedScoreParts[0]) || 0;
                                    const predHomeScore = parseFloat(predictedScoreParts[1]) || 0;
                                    
                                    // Parse actual score
                                    const actualScoreParts = game.actual_score.split('-');
                                    const actualAwayScore = parseFloat(actualScoreParts[0]) || 0;
                                    const actualHomeScore = parseFloat(actualScoreParts[1]) || 0;
                                    
                                    const formattedGame = {
                                        away_team: game.away_team,
                                        home_team: game.home_team,
                                        display_date: game.date,
                                        game_id: game.away_team + '_' + game.home_team + '_' + game.date,
                                        predicted_score: game.predicted_score,
                                        actual_score: game.actual_score,
                                        predicted_total: game.predicted_total,
                                        actual_total: game.actual_total,
                                        winner_correct: game.winner_correct,
                                        total_correct: game.total_correct,
                                        perfect_game: game.perfect_game,
                                        prediction: {
                                            predicted_away_score: predAwayScore,
                                            predicted_home_score: predHomeScore,
                                            predicted_total_runs: game.predicted_total,
                                            away_win_probability: predAwayScore > predHomeScore ? 0.6 : 0.4,
                                            home_win_probability: predHomeScore > predAwayScore ? 0.6 : 0.4,
                                            predicted_winner: predAwayScore > predHomeScore ? game.away_team : game.home_team,
                                            away_pitcher: 'TBD',
                                            home_pitcher: 'TBD'
                                        },
                                        result: {
                                            status: 'Final',
                                            away_score: actualAwayScore,
                                            home_score: actualHomeScore
                                        },
                                        performance_analysis: {
                                            winner_correct: game.winner_correct,
                                            total_correct: game.total_correct,
                                            overall_grade: game.perfect_game ? 'A+' : (game.winner_correct && game.total_correct ? 'A' : (game.winner_correct || game.total_correct ? 'B' : 'C')),
                                            grade_percentage: game.perfect_game ? 1.0 : (game.winner_correct && game.total_correct ? 0.9 : (game.winner_correct || game.total_correct ? 0.7 : 0.3))
                                        }
                                    };
                                    
                                    console.log('✅ Formatted game:', formattedGame.game_id, 'prediction:', formattedGame.prediction);
                                    return formattedGame;
                                });
                                
                                displayMultiDateResults(formattedGames);
                                hideStatus();
                            } else {
                                console.error('No games found or invalid data structure:', data);
                                showError('No ' + FILTER_TYPE + ' games found');
                            }
                        } catch (e) {
                            console.error('Error parsing filtered games data:', e);
                            showError('Error loading ' + FILTER_TYPE + ' games');
                        }
                    } else {
                        console.error('Failed to load filtered games, status:', xhr.status);
                        showError('Failed to load ' + FILTER_TYPE + ' games (HTTP ' + xhr.status + ')');
                    }
                }
            };
            
            xhr.ontimeout = function() {
                console.error('Timeout loading filtered games');
                showError('Timeout loading ' + FILTER_TYPE + ' games');
            };
            
            xhr.onerror = function() {
                console.error('Error loading filtered games');
                showError('Error loading ' + FILTER_TYPE + ' games');
            };
            
            xhr.send();
        }
        
        function loadDatesParallel(dates, callback) {
            let allFilteredGames = [];
            let completedRequests = 0;
            let totalRequests = dates.length;
            
            // Set a timeout to prevent hanging
            const timeoutId = setTimeout(function() {
                console.log('Timeout reached, returning results found so far');
                clearTimeout(timeoutId);
                callback(allFilteredGames);
            }, 5000); // 5 second timeout for each batch
            
            function checkIfComplete() {
                if (completedRequests >= totalRequests) {
                    clearTimeout(timeoutId);
                    callback(allFilteredGames);
                }
            }
            
            // Load all dates in parallel for much faster loading
            dates.forEach(function(currentDate, index) {
                console.log('Starting request for date:', currentDate);
                
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/api/historical-recap/' + currentDate, true);
                xhr.timeout = 2000; // 2 seconds per request
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        completedRequests++;
                        showStatus('Loading ' + FILTER_TYPE + ' games... (' + completedRequests + '/' + totalRequests + ')');
                        
                        if (xhr.status === 200) {
                            try {
                                const data = JSON.parse(xhr.responseText);
                                if (data.success && data.games) {
                                    console.log(`Processing ${data.games.length} games for ${currentDate}`);
                                    
                                    // Count completed games for debugging  
                                    const completedGames = data.games.filter(g => g.result && g.result.status === 'Final');
                                    console.log(`Found ${completedGames.length} completed games out of ${data.games.length} total on ${currentDate}`);
                                    updateDebugInfo(`${currentDate}: Processing ${data.games.length} games (${completedGames.length} completed)`);
                                    
                                    // Log first game structure for debugging
                                    if (data.games.length > 0 && dateIndex === 0) {
                                        const sampleGame = data.games[0];
                                        console.log('Sample game structure:', {
                                            away_team: sampleGame.away_team,
                                            home_team: sampleGame.home_team,
                                            predicted_total_runs: sampleGame.predicted_total_runs,
                                            result: sampleGame.result,
                                            betting_recommendations: sampleGame.betting_recommendations,
                                            performance_analysis: sampleGame.performance_analysis
                                        });
                                        updateDebugInfo(`Sample game: ${sampleGame.away_team} @ ${sampleGame.home_team}, Pred Total: ${sampleGame.predicted_total_runs}, Result: ${sampleGame.result?.away_score}-${sampleGame.result?.home_score}`);
                                    }
                    // Helper function to check over/under prediction accuracy
                    function checkOverUnderAccuracy(game) {
                        // First, let's just check if the game has the basic data we need
                        if (!game.result || game.result.status !== 'Final') {
                            return false;
                        }
                        
                        const predTotal = game.predicted_total_runs || 0;
                        const actualTotal = (game.result?.away_score || 0) + (game.result?.home_score || 0);
                        
                        // For debugging, let's be very lenient and just check if we have basic data
                        if (predTotal > 0 && actualTotal > 0) {
                            updateDebugInfo(`FOUND GAME: ${game.away_team} @ ${game.home_team} - Pred: ${predTotal}, Actual: ${actualTotal}`);
                            
                            // Now do the actual over/under calculation
                            let bettingLine = 9.5; // Default
                            if (game.betting_recommendations && game.betting_recommendations.total_runs) {
                                for (let rec of game.betting_recommendations.total_runs) {
                                    if (rec.line) {
                                        bettingLine = rec.line;
                                        break;
                                    }
                                }
                            }
                            
                            const predOverUnder = predTotal > bettingLine ? 'OVER' : 'UNDER';
                            const actualOverUnder = actualTotal > bettingLine ? 'OVER' : 'UNDER';
                            const isCorrect = predOverUnder === actualOverUnder;
                            
                            updateDebugInfo(`O/U Check: Pred ${predTotal} (${predOverUnder}) vs Actual ${actualTotal} (${actualOverUnder}) Line ${bettingLine} = ${isCorrect ? 'CORRECT' : 'WRONG'}`);
                            
                            return isCorrect;
                        }
                        
                        return false;
                    }                                    // Filter games for this date - match main page calculation logic
                                    const filteredGames = data.games.filter(function(game) {
                                        // Only count games that are Final (have actual results)
                                        if (!game.result || game.result.status !== 'Final') {
                                            return false;
                                        }
                                        
                                        const analysis = game.performance_analysis || {};
                                        
                                        // Log the game being checked for debugging
                                        updateDebugInfo(`CHECKING FINAL GAME: ${game.away_team} @ ${game.home_team} - Analysis: ${JSON.stringify(analysis)}`);
                                        
                                        let isWinnerCorrect, isTotalCorrect, isPerfectGame;
                                        
                                        switch(FILTER_TYPE) {
                                            case 'winners':
                                                isWinnerCorrect = analysis.winner_correct === true;
                                                if (isWinnerCorrect) {
                                                    updateDebugInfo(`✅ WINNER CORRECT: ${game.away_team} @ ${game.home_team}`);
                                                }
                                                return isWinnerCorrect;
                                                
                                            case 'totals':
                                                isTotalCorrect = analysis.total_correct === true;
                                                if (isTotalCorrect) {
                                                    updateDebugInfo(`✅ TOTAL CORRECT: ${game.away_team} @ ${game.home_team}`);
                                                }
                                                return isTotalCorrect;
                                                
                                            case 'perfect':
                                                isWinnerCorrect = analysis.winner_correct === true;
                                                isTotalCorrect = analysis.total_correct === true;
                                                isPerfectGame = isWinnerCorrect && isTotalCorrect;
                                                if (isPerfectGame) {
                                                    updateDebugInfo(`✅ PERFECT GAME: ${game.away_team} @ ${game.home_team}`);
                                                }
                                                return isPerfectGame;
                                                
                                            default:
                                                return true;
                                        }
                                    });
                                    
                                    // Add date to each game for display
                                    filteredGames.forEach(function(game) {
                                        game.display_date = currentDate;
                                    });
                                    
                                    allFilteredGames = allFilteredGames.concat(filteredGames);
                                    console.log('Found', filteredGames.length, 'matching games on', currentDate);
                                    
                                    // Update progress with current count
                                    if (filteredGames.length > 0) {
                                        showStatus('Found ' + allFilteredGames.length + ' ' + FILTER_TYPE + ' games so far... (' + completedRequests + '/' + totalRequests + ')');
                                    }
                                }
                            } catch (e) {
                                console.error('Error parsing data for', currentDate, ':', e);
                            }
                        } else {
                            console.log('Failed to load data for', currentDate, '- Status:', xhr.status);
                        }
                        
                        checkIfComplete();
                    }
                };
                
                xhr.ontimeout = function() {
                    console.log('Request timeout for', currentDate);
                    completedRequests++;
                    checkIfComplete();
                };
                
                xhr.onerror = function() {
                    console.log('Request error for', currentDate);
                    completedRequests++;
                    checkIfComplete();
                };
                
                xhr.send();
            });
        }

        function displayMultiDateResults(games) {
            console.log('Displaying', games.length, 'filtered games from multiple dates');
            
            // Update the recap section with multi-date info
            const recapSection = document.getElementById('recap-section');
            recapSection.style.display = 'block';
            
            // Count unique dates
            const uniqueDates = [...new Set(games.map(g => g.display_date))];
            
            document.getElementById('total-games').textContent = games.length;
            document.getElementById('correct-predictions').textContent = games.length;
            
            // Update title
            const titleElement = document.querySelector('.recap-title');
            if (titleElement) {
                let filterTitle = '';
                switch(FILTER_TYPE) {
                    case 'winners': filterTitle = 'Correct Winner Predictions'; break;
                    case 'totals': filterTitle = 'Correct Total Predictions'; break;
                    case 'perfect': filterTitle = 'Perfect Games'; break;
                }
                titleElement.textContent = filterTitle + ' - ' + games.length + ' games across ' + uniqueDates.length + ' dates';
            }
            
            // Display the games
            displayGames(games);
            updateDebugInfo('Displayed ' + games.length + ' ' + FILTER_TYPE + ' games from ' + uniqueDates.length + ' dates');
        }

        function showNoResultsMessage() {
            const container = document.getElementById('games-container');
            container.innerHTML = '';
            
            const noResults = document.createElement('div');
            noResults.className = 'status';
            
            let filterMessage = '';
            switch(FILTER_TYPE) {
                case 'winners':
                    filterMessage = '🎯 No correct winner predictions found in recent games';
                    break;
                case 'totals':
                    filterMessage = '📊 No correct total predictions found in recent games';
                    break;
                case 'perfect':
                    filterMessage = '💎 No perfect games found in recent dates';
                    break;
            }
            
            // Get the debug info that was collected
            const debugElement = document.getElementById('debug-info');
            const debugInfo = debugElement ? debugElement.textContent : '';
            
            noResults.innerHTML = `
                <h3>${filterMessage}</h3>
                <p>We searched the last 9 days of games (Aug 7-15) but didn't find any matches for this filter.</p>
                ${debugInfo ? `<div style="background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap;">${debugInfo}</div>` : ''}
                <div style="margin-top: 15px;">
                    <a href="/historical?filter=all" class="btn" style="text-decoration: none; margin-right: 10px;">📊 View All Games</a>
                    <a href="/" class="btn home" style="text-decoration: none;">🏠 Back to Dashboard</a>
                </div>
            `;
            container.appendChild(noResults);
            hideStatus();
        }

        function loadAnalysis() {
            const date = document.getElementById('analysis-date').value;
            if (!date) {
                alert('Please select a date');
                updateDebugInfo('ERROR: No date selected');
                return;
            }

            console.log('Loading analysis for:', date);
            updateDebugInfo('Starting API call for date: ' + date);
            showStatus('🔄 Loading analysis for ' + date + '...');
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/historical-recap/' + date, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    updateDebugInfo('API response received, status: ' + xhr.status);
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            console.log('Data received:', data);
                            updateDebugInfo('Data parsed successfully, success: ' + data.success + ', games: ' + (data.games ? data.games.length : 'null'));
                            
                            if (data.success && data.games && data.games.length > 0) {
                                updateDebugInfo('Calling displayRecap and displayGames...');
                                displayRecap(data, date);
                                displayGames(data.games);
                                hideStatus();
                                updateDebugInfo('Display complete - ' + data.games.length + ' games shown');
                            } else {
                                updateDebugInfo('ERROR: No games condition failed');
                                showStatus('❌ No games found for ' + date);
                            }
                        } catch (error) {
                            console.error('Parse error:', error);
                            updateDebugInfo('ERROR: Parse error - ' + error.message);
                            showStatus('❌ Error loading data: ' + error.message);
                        }
                    } else {
                        console.error('HTTP error:', xhr.status);
                        updateDebugInfo('ERROR: HTTP error ' + xhr.status);
                        showStatus('❌ Failed to load data (HTTP ' + xhr.status + ')');
                    }
                }
            };
            xhr.send();
        }

        function showStatus(message) {
            const status = document.getElementById('status');
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        function displayRecap(data, date) {
            try {
                console.log('Displaying recap for', data.games.length, 'games');
                
                const recapSection = document.getElementById('recap-section');
                recapSection.style.display = 'block';

                // Update date in title
                const dateObj = new Date(date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.querySelector('.recap-title').textContent = 'Performance Recap - ' + formattedDate;

                // Calculate stats
                const games = data.games;
                const gamesWithAnalysis = games.filter(function(game) {
                    return game.performance_analysis;
                });
                
                const correctWinners = gamesWithAnalysis.filter(function(game) {
                    return game.performance_analysis.winner_correct;
                }).length;
                
                const gradePoints = gamesWithAnalysis.map(function(game) {
                    const percentage = game.performance_analysis.grade_percentage;
                    return (percentage !== null && percentage !== undefined && !isNaN(percentage)) ? Number(percentage) : 0;
                });
                
                const avgGrade = gradePoints.length > 0 ? 
                    gradePoints.reduce(function(a, b) { return a + b; }, 0) / gradePoints.length : 0;

                const aPlusCount = gamesWithAnalysis.filter(function(game) {
                    return game.performance_analysis.grade === 'A+';
                }).length;

                // Update display
                document.getElementById('total-games').textContent = games.length;
                document.getElementById('correct-predictions').textContent = correctWinners + '/' + gamesWithAnalysis.length;
                document.getElementById('accuracy-rate').textContent = gamesWithAnalysis.length > 0 ? 
                    ((correctWinners / gamesWithAnalysis.length) * 100).toFixed(1) + '%' : 'N/A';
                document.getElementById('average-grade').textContent = avgGrade > 0 ? avgGrade.toFixed(1) + '%' : 'N/A';
                document.getElementById('best-predictions').textContent = aPlusCount;
                
                // Load performance analytics
                loadPerformanceAnalytics(date);
                loadComprehensiveBettingPerformance();

            } catch (error) {
                console.error('Error in displayRecap:', error);
            }
        }

        function displayGames(games) {
            console.log('Displaying', games.length, 'games with filter:', FILTER_TYPE);
            updateDebugInfo('displayGames called with ' + games.length + ' games, filter: ' + FILTER_TYPE);
            
            // Data is already filtered by the API, so no need to filter again
            const filteredGames = games;
            
            const container = document.getElementById('games-container');
            container.innerHTML = '';

            if (filteredGames.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'status';
                
                let filterMessage = '';
                switch(FILTER_TYPE) {
                    case 'winners':
                        filterMessage = '🎯 No correct winner predictions found for this date';
                        break;
                    case 'totals':
                        filterMessage = '📊 No correct total predictions found for this date';
                        break;
                    case 'perfect':
                        filterMessage = '� No perfect games found for this date';
                        break;
                    default:
                        filterMessage = '📊 No games found for this date';
                        break;
                }
                
                noResults.innerHTML = `
                    <h3>${filterMessage}</h3>
                    <p>Try selecting a different date or use the "All Games" filter to see all predictions.</p>
                    <div style="margin-top: 15px;">
                        <a href="/historical?filter=all" class="btn" style="text-decoration: none; margin-right: 10px;">📊 View All Games</a>
                        <button class="btn secondary" onclick="loadToday()">📅 Try Yesterday</button>
                    </div>
                `;
                container.appendChild(noResults);
                return;
            }

            const gamesGrid = document.createElement('div');
            gamesGrid.className = 'games-grid';

            for (var i = 0; i < filteredGames.length; i++) {
                try {
                    const gameCard = createGameCard(filteredGames[i]);
                    gamesGrid.appendChild(gameCard);
                } catch (error) {
                    console.error('Error creating game card:', error);
                    updateDebugInfo('ERROR creating game card ' + i + ': ' + error.message);
                    const errorCard = document.createElement('div');
                    errorCard.className = 'game-card error';
                    errorCard.innerHTML = '<p>Error displaying game: ' + (filteredGames[i].away_team || 'Unknown') + ' @ ' + (filteredGames[i].home_team || 'Unknown') + '</p>';
                    gamesGrid.appendChild(errorCard);
                }
            }

            container.appendChild(gamesGrid);
            updateDebugInfo('Games display completed successfully - ' + filteredGames.length + ' filtered games shown');
        }

        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';

            const prediction = game.prediction || {};
            const result = game.result || {};
            const analysis = game.performance_analysis || {};
            
            const isComplete = result.away_score !== null && result.home_score !== null && 
                             result.away_score !== undefined && result.home_score !== undefined;
            const actualWinner = isComplete ? 
                (result.away_score > result.home_score ? game.away_team : game.home_team) : '';
            
            // Calculate predicted winner from probabilities
            let predictedWinner = 'N/A';
            if (prediction.away_win_probability && prediction.home_win_probability) {
                if (prediction.away_win_probability > prediction.home_win_probability) {
                    predictedWinner = game.away_team;
                } else if (prediction.home_win_probability > prediction.away_win_probability) {
                    predictedWinner = game.home_team;
                } else {
                    predictedWinner = 'Tie/Close';
                }
            } else if (prediction.predicted_winner) {
                predictedWinner = prediction.predicted_winner;
            }
            
            const grade = analysis.overall_grade || 'N/A';
            const gradePercentage = analysis.grade_percentage;
            
            // Safe helper functions
            function safeToFixed(value, decimals) {
                if (value === null || value === undefined || isNaN(value)) {
                    return 'N/A';
                }
                return Number(value).toFixed(decimals);
            }
            
            function safePercentage(value) {
                if (value === null || value === undefined || isNaN(value)) {
                    return 'N/A';
                }
                return Number(value * 100).toFixed(1) + '%';
            }
        
            card.innerHTML = 
                (game.display_date ? '<div class="game-date-header" style="background: rgba(79, 209, 199, 0.2); padding: 5px 10px; font-size: 0.9em; font-weight: bold; border-radius: 5px 5px 0 0; margin-bottom: 10px;">' + game.display_date + '</div>' : '') +
                '<div class="game-header">' +
                    '<div class="game-teams">' +
                        '<span class="away-team">' + game.away_team + '</span>' +
                        '<span class="versus">@</span>' +
                        '<span class="home-team">' + game.home_team + '</span>' +
                    '</div>' +
                    '<div class="game-score">' +
                        (isComplete ? 
                            '<span class="final-score">' + result.away_score + ' - ' + result.home_score + '</span>' :
                            '<span class="game-time">' + (game.game_time || 'TBD') + '</span>') +
                    '</div>' +
                '</div>' +
                
                '<div class="prediction-section">' +
                    '<h4>🎯 Our Prediction</h4>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Winner:</span>' +
                        '<span class="prediction-value winner-pred ' + 
                            (predictedWinner === actualWinner && isComplete ? 'correct' : 
                             isComplete ? 'incorrect' : '') + '">' + 
                            predictedWinner + 
                            (isComplete ? (predictedWinner === actualWinner ? ' ✅' : ' ❌') : '') +
                        '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Away Win Prob:</span>' +
                        '<span class="prediction-value">' + safePercentage(prediction.away_win_probability) + '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Home Win Prob:</span>' +
                        '<span class="prediction-value">' + safePercentage(prediction.home_win_probability) + '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Predicted Score:</span>' +
                        '<span class="prediction-value">' + 
                            (prediction.predicted_away_score !== undefined && prediction.predicted_home_score !== undefined ? 
                                safeToFixed(prediction.predicted_away_score, 1) + ' - ' + safeToFixed(prediction.predicted_home_score, 1) : 'N/A') +
                        '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Total Runs:</span>' +
                        '<span class="prediction-value">' + safeToFixed(prediction.predicted_total_runs, 1) + '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Pitchers:</span>' +
                        '<span class="prediction-value">' + (prediction.away_pitcher || 'TBD') + ' vs ' + (prediction.home_pitcher || 'TBD') + '</span>' +
                    '</div>' +
                '</div>' +
                
                (isComplete ?
                '<div class="performance-section">' +
                    '<h4>📊 Performance Analysis</h4>' +
                    '<div class="performance-grade grade-' + (grade.toLowerCase().replace('+', 'plus').replace('-', 'minus')) + '">' +
                        '<div class="grade-display">' +
                            '<span class="grade-letter">' + grade + '</span>' +
                            '<span class="grade-percentage">' + safePercentage(gradePercentage) + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="performance-details">' +
                        '<p><strong>Winner Prediction:</strong> ' + (analysis.winner_correct ? '✅ Correct' : '❌ Incorrect') + '</p>' +
                        (analysis.score_accuracy ? 
                            '<p><strong>Score Accuracy:</strong> ±' + safeToFixed(analysis.score_accuracy.total_diff, 1) + ' runs</p>' : '') +
                    '</div>' +
                '</div>' :
                '<div class="status"><p>🔄 Game in progress</p></div>') +
            
            '<div style="margin-top: 10px; font-size: 0.8rem; color: #94a3b8;">' +
                'Game ID: ' + game.game_id +
            '</div>';

            return card;
        }

        // Performance Analytics Functions
        function loadPerformanceAnalytics(date) {
            console.log('Loading performance analytics for', date);
            updateDebugInfo('Loading performance analytics for ' + date);
            
            fetch('/api/historical-recap/' + date)
                .then(response => response.json())
                .then(data => {
                    console.log('Performance analytics response:', data);
                    if (data.success && data.games) {
                        // Extract analytics from the historical recap data
                        const analytics = extractAnalyticsFromGames(data.games);
                        displayPerformanceAnalytics(analytics);
                    } else {
                        console.error('Performance analytics failed:', data.error || 'No games data');
                        updateDebugInfo('Performance analytics failed: ' + (data.error || 'No games data'));
                    }
                })
                .catch(error => {
                    console.error('Error loading performance analytics:', error);
                    updateDebugInfo('Error loading performance analytics: ' + error.message);
                });
        }

        function extractAnalyticsFromGames(games) {
            // Extract performance analytics from games data
            const completedGames = games.filter(g => g.result && g.result.status === 'Final');
            const winnerCorrect = completedGames.filter(g => g.performance_analysis && g.performance_analysis.winner_correct);
            const totalCorrect = completedGames.filter(g => g.performance_analysis && g.performance_analysis.total_correct);
            
            // Calculate winner performance
            const winnerAccuracy = completedGames.length > 0 ? (winnerCorrect.length / completedGames.length * 100) : 0;
            
            // Calculate score performance (simplified)
            let totalScoreDiff = 0;
            let totalRunsDiff = 0;
            completedGames.forEach(game => {
                if (game.performance_analysis) {
                    totalScoreDiff += Math.abs((game.performance_analysis.away_score_diff || 0) + (game.performance_analysis.home_score_diff || 0)) / 2;
                    totalRunsDiff += Math.abs(game.performance_analysis.total_score_diff || 0);
                }
            });
            
            const avgScoreDiff = completedGames.length > 0 ? totalScoreDiff / completedGames.length : 0;
            const avgTotalDiff = completedGames.length > 0 ? totalRunsDiff / completedGames.length : 0;
            
            // Calculate overall system grade (simplified)
            const overallPercentage = completedGames.length > 0 ? (winnerCorrect.length + totalCorrect.length) / (completedGames.length * 2) * 100 : 0;
            let systemGrade = 'F';
            if (overallPercentage >= 90) systemGrade = 'A+';
            else if (overallPercentage >= 85) systemGrade = 'A';
            else if (overallPercentage >= 80) systemGrade = 'A-';
            else if (overallPercentage >= 75) systemGrade = 'B+';
            else if (overallPercentage >= 70) systemGrade = 'B';
            else if (overallPercentage >= 65) systemGrade = 'B-';
            else if (overallPercentage >= 60) systemGrade = 'C+';
            else if (overallPercentage >= 55) systemGrade = 'C';
            else if (overallPercentage >= 50) systemGrade = 'C-';
            else if (overallPercentage >= 45) systemGrade = 'D+';
            else if (overallPercentage >= 40) systemGrade = 'D';
            
            // Create grade distribution (simplified)
            const gradeDistribution = {};
            const grades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D', 'F'];
            grades.forEach(grade => gradeDistribution[grade] = 0);
            
            // Assign games to grades based on individual performance
            completedGames.forEach(game => {
                if (game.performance_analysis) {
                    const gameScore = ((game.performance_analysis.winner_correct ? 1 : 0) + (game.performance_analysis.total_correct ? 1 : 0)) / 2 * 100;
                    let gameGrade = 'F';
                    if (gameScore >= 90) gameGrade = 'A+';
                    else if (gameScore >= 85) gameGrade = 'A';
                    else if (gameScore >= 80) gameGrade = 'A-';
                    else if (gameScore >= 75) gameGrade = 'B+';
                    else if (gameScore >= 70) gameGrade = 'B';
                    else if (gameScore >= 65) gameGrade = 'B-';
                    else if (gameScore >= 60) gameGrade = 'C+';
                    else if (gameScore >= 55) gameGrade = 'C';
                    else if (gameScore >= 50) gameGrade = 'C-';
                    else if (gameScore >= 45) gameGrade = 'D+';
                    else if (gameScore >= 40) gameGrade = 'D';
                    
                    gradeDistribution[gameGrade]++;
                }
            });
            
            return {
                winner_performance: {
                    accuracy_rate: winnerAccuracy,
                    by_confidence: {
                        high: {
                            accuracy: winnerAccuracy // Simplified - using overall accuracy
                        }
                    }
                },
                score_performance: {
                    avg_away_diff: avgScoreDiff / 2,
                    avg_home_diff: avgScoreDiff / 2,
                    avg_total_diff: avgTotalDiff
                },
                overall_system_grade: overallPercentage,
                overall_system_letter: systemGrade,
                grade_distribution: gradeDistribution
            };
        }

        function displayPerformanceAnalytics(analytics) {
            console.log('Displaying performance analytics:', analytics);
            
            // Show the system performance section
            document.getElementById('system-performance').style.display = 'block';
            
            // Update winner prediction metrics
            const winnerPerf = analytics.winner_performance || {};
            document.getElementById('winner-accuracy').textContent = (winnerPerf.accuracy_rate || 0).toFixed(1) + '%';
            
            const highConfidence = winnerPerf.by_confidence?.high || {};
            document.getElementById('high-confidence-accuracy').textContent = (highConfidence.accuracy || 0).toFixed(1) + '%';
            
            // Update score prediction metrics
            const scorePerf = analytics.score_performance || {};
            const avgScoreDiff = ((scorePerf.avg_away_diff || 0) + (scorePerf.avg_home_diff || 0)) / 2;
            document.getElementById('avg-score-diff').textContent = avgScoreDiff.toFixed(1);
            document.getElementById('total-runs-diff').textContent = (scorePerf.avg_total_diff || 0).toFixed(1);
            
            // Update system grade
            const systemGrade = analytics.overall_system_letter || 'N/A';
            const systemPercentage = analytics.overall_system_grade || 0;
            document.getElementById('system-grade').textContent = systemGrade + ' (' + systemPercentage.toFixed(1) + '%)';
            
            // Update grade distribution
            displayGradeDistribution(analytics.grade_distribution || {});
            
            updateDebugInfo('Performance analytics displayed successfully');
        }

        // Comprehensive Betting Performance Functions
        function loadComprehensiveBettingPerformance() {
            console.log('Loading comprehensive betting performance data');
            updateDebugInfo('Loading comprehensive betting performance data');
            
            fetch('/api/comprehensive-betting-performance')
                .then(response => response.json())
                .then(data => {
                    console.log('Comprehensive betting performance response:', data);
                    if (data.success && data.performance) {
                        displayComprehensiveBettingPerformance(data.performance);
                    } else {
                        console.error('Comprehensive betting performance failed:', data.error || 'No performance data');
                        updateDebugInfo('Comprehensive betting performance failed: ' + (data.error || 'No performance data'));
                    }
                })
                .catch(error => {
                    console.error('Error loading comprehensive betting performance:', error);
                    updateDebugInfo('Error loading comprehensive betting performance: ' + error.message);
                });
        }

        function displayComprehensiveBettingPerformance(performance) {
            console.log('Displaying comprehensive betting performance:', performance);
            
            // Show the comprehensive betting performance section
            document.getElementById('comprehensive-betting-performance').style.display = 'block';
            
            const overall = performance.overall || {};
            
            // Moneyline Performance
            const moneyline = overall.moneyline || {};
            document.getElementById('ml-total-bets').textContent = moneyline.total_bets || '0';
            document.getElementById('ml-win-rate').textContent = (moneyline.win_rate || 0).toFixed(1) + '%';
            document.getElementById('ml-roi').textContent = (moneyline.roi || 0).toFixed(1) + '%';
            const mlProfit = moneyline.total_profit || 0;
            const mlProfitElement = document.getElementById('ml-total-profit');
            mlProfitElement.textContent = (mlProfit >= 0 ? '+' : '') + '$' + mlProfit.toFixed(0);
            mlProfitElement.style.color = mlProfit >= 0 ? '#4ade80' : '#f87171';
            
            // Totals Performance
            const totals = overall.totals || {};
            document.getElementById('totals-total-bets').textContent = totals.total_bets || '0';
            document.getElementById('totals-win-rate').textContent = (totals.win_rate || 0).toFixed(1) + '%';
            document.getElementById('totals-roi').textContent = (totals.roi || 0).toFixed(1) + '%';
            const totalsProfit = totals.total_profit || 0;
            const totalsProfitElement = document.getElementById('totals-total-profit');
            totalsProfitElement.textContent = (totalsProfit >= 0 ? '+' : '') + '$' + totalsProfit.toFixed(0);
            totalsProfitElement.style.color = totalsProfit >= 0 ? '#4ade80' : '#f87171';
            
            // Run Line Performance
            const runLine = overall.run_line || {};
            document.getElementById('rl-total-bets').textContent = runLine.total_bets || '0';
            document.getElementById('rl-win-rate').textContent = (runLine.win_rate || 0).toFixed(1) + '%';
            document.getElementById('rl-roi').textContent = (runLine.roi || 0).toFixed(1) + '%';
            const rlProfit = runLine.total_profit || 0;
            const rlProfitElement = document.getElementById('rl-total-profit');
            rlProfitElement.textContent = (rlProfit >= 0 ? '+' : '') + '$' + rlProfit.toFixed(0);
            rlProfitElement.style.color = rlProfit >= 0 ? '#4ade80' : '#f87171';
            
            // Perfect Games Performance
            const perfectGames = overall.perfect_games || {};
            document.getElementById('perfect-opportunities').textContent = perfectGames.total_bets || '0';
            document.getElementById('perfect-hits').textContent = perfectGames.total_wins || '0';
            document.getElementById('perfect-success-rate').textContent = (perfectGames.win_rate || 0).toFixed(1) + '%';
            
            updateDebugInfo('Comprehensive betting performance displayed successfully');
        }

        function showBettingType(bettingType) {
            // Hide all betting type sections
            const sections = document.querySelectorAll('.betting-type-section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected betting type section
            const targetSection = document.getElementById(bettingType + '-performance');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Add active class to clicked tab
            const clickedTab = event.target;
            clickedTab.classList.add('active');
        }

        function displayGradeDistribution(gradeDistribution) {
            const gradeChart = document.getElementById('grade-chart');
            gradeChart.innerHTML = '';
            
            const grades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D'];
            
            grades.forEach(grade => {
                const count = gradeDistribution[grade] || 0;
                const gradeBar = document.createElement('div');
                gradeBar.className = 'grade-bar' + (count > 0 ? ' has-games' : '');
                
                gradeBar.innerHTML = 
                    '<div class="grade-label">' + grade + '</div>' +
                    '<div class="grade-count">' + count + '</div>';
                
                gradeChart.appendChild(gradeBar);
            });
        }

        // Modify the loadHistoricalRecap function to also load performance analytics
        function loadHistoricalRecap(date) {
            if (!date) {
                updateDebugInfo('No date provided to loadHistoricalRecap');
                return;
            }

            updateDebugInfo('Loading historical recap for ' + date);
            document.getElementById('recap-section').style.display = 'block';
            
            fetch('/api/historical-recap/' + date)
                .then(response => {
                    updateDebugInfo('Received response, status: ' + response.status);
                    return response.json();
                })
                .then(data => {
                    updateDebugInfo('Data parsed successfully, success: ' + data.success + ', games: ' + (data.games ? data.games.length : 'null'));
                    
                    if (data.success && data.games && data.games.length > 0) {
                        const formattedDate = formatDate(date);
                        document.querySelector('.recap-title').textContent = 'Performance Recap - ' + formattedDate;
                        displayGames(data.games);
                        updateStats(data.games);
                        updateDebugInfo('Display complete - ' + data.games.length + ' games shown');
                        
                        // Load performance analytics
                        loadPerformanceAnalytics(date);
                        loadComprehensiveBettingPerformance();
                    } else {
                        updateDebugInfo('No games found for ' + date);
                        document.getElementById('games-container').innerHTML = '<div class="status error">No games found for ' + date + '</div>';
                    }
                })
                .catch(error => {
                    updateDebugInfo('Error: ' + error.message);
                    console.error('Error loading historical recap:', error);
                    document.getElementById('games-container').innerHTML = '<div class="status error">Error loading data: ' + error.message + '</div>';
                });
        }
    </script>
</body>
</html>
