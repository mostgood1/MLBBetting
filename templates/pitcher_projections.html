<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pitcher Projections</title>
<style>
 body { font-family: Inter, Arial, sans-serif; background:#0b1e39; margin:0; color:#111; }
 .container { max-width:1200px; margin:0 auto; padding:24px; }
 .card { background:#fff; border-radius:14px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.15); margin-bottom:18px; }
 h1 { color:#163a6b; margin:0 0 10px; }
 table { width:100%; border-collapse:collapse; }
 th,td { padding:8px 10px; border-bottom:1px solid #eee; font-size:13px; text-align:left; }
 .muted { color:#555; font-size:12px; }
 .badge { padding:3px 7px; border-radius:999px; font-size:11px; font-weight:600; }
 .badge.HIGH { background:#16a34a; color:#fff; }
 .badge.MEDIUM { background:#2563eb; color:#fff; }
 .badge.LOW { background:#eab308; color:#111; }
 .table-wrap { overflow-x:auto; overflow-y:visible; position:relative; -webkit-overflow-scrolling:touch; }
 /* Dynamic width so advanced columns aren't clipped */
 .table-wrap:not(.hide-adv) #proj-table { min-width:1800px; }
 .table-wrap.hide-adv #proj-table { min-width:1100px; }
 /* Keep header row readable while scrolling */
 #proj-table thead th { position:sticky; top:0; background:#f3f6fa; z-index:5; }
 /* Freeze first column (Pitcher) */
 #proj-table th:first-child, #proj-table td:first-child { position:sticky; left:0; background:#fff; z-index:6; box-shadow:2px 0 4px rgba(0,0,0,0.06); }
 .compact th, .compact td { white-space:nowrap; }
 .hide-adv .col-adv { display:none; }
 .col-group { background:#f5f7fb; font-size:10px; text-transform:uppercase; letter-spacing:0.5px; }
 .btn { background:#163a6b; color:#fff; padding:8px 14px; border:none; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; }
 .edge-pos { background:rgba(34,197,94,0.18); }
 .edge-neg { background:rgba(239,68,68,0.18); }
 .edge-strong { outline:2px solid #16a34a; }
 .edge-strong-neg { outline:2px solid #ef4444; }
 .row-live { background:rgba(99,102,241,0.12); box-shadow: inset 3px 0 0 #6366f1; }
 .rec-win { background:rgba(34,197,94,0.22) !important; }
 .rec-loss { background:rgba(239,68,68,0.22) !important; }
 .tabs { display:flex; gap:6px; flex-wrap:wrap; }
 .tab { background:#fff; color:#163a6b; border:1px solid #cfe1f8; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
 .tab.active { background:#163a6b; color:#fff; border-color:#163a6b; }
 @media (max-width:760px){ th,td { font-size:11px; padding:6px 6px; } }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
      <h1>Pitcher Projections (Daily)</h1>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
  <a class="btn" href="/">⬅ Main</a>
  <a class="btn" href="/betting-recommendations">Betting Recs</a>
        <button class="btn" onclick="exportJSON()">💾 Export JSON</button>
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#163a6b;background:#fff;padding:4px 8px;border-radius:6px;">
          <input type="checkbox" id="toggle-nolines" onchange="renderRows()" /> Hide no-line rows
        </label>
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#163a6b;background:#fff;padding:4px 8px;border-radius:6px;">
          <input type="checkbox" id="toggle-adv" checked onchange="toggleAdvanced()" /> Show advanced cols
        </label>
        <label style="font-size:12px;display:flex;align-items:center;gap:4px;color:#163a6b;background:#fff;padding:4px 8px;border-radius:6px;">
          Sort:
          <select id="sort-edge" onchange="renderRows()" style="font-size:12px;">
            <option value="">None</option>
            <option value="strikeouts">Edge K</option>
            <option value="outs">Edge Outs</option>
            <option value="hits_allowed">Edge Hits</option>
            <option value="walks">Edge Walks</option>
            <option value="earned_runs">Edge ER</option>
          </select>
        </label>
        <!-- Per-stat tabs -->
        <div class="tabs" id="stat-tabs" style="margin:2px 0;">
          <div class="tab active" data-stat="">All</div>
          <div class="tab" data-stat="strikeouts">K</div>
          <div class="tab" data-stat="outs">Outs</div>
          <div class="tab" data-stat="earned_runs">ER</div>
          <div class="tab" data-stat="hits_allowed">Hits</div>
          <div class="tab" data-stat="walks">BB</div>
        </div>
        <!-- Keep old dropdown hidden as a fallback -->
        <label style="display:none">
          <select id="filter-stat" onchange="renderRows()">
            <option value="">All</option>
            <option value="strikeouts">K</option>
            <option value="outs">Outs</option>
            <option value="earned_runs">ER</option>
            <option value="hits_allowed">Hits</option>
            <option value="walks">BB</option>
          </select>
        </label>
        <label style="font-size:12px;display:flex;align-items:center;gap:6px;color:#163a6b;background:#fff;padding:4px 8px;border-radius:6px;">
          <input type="checkbox" id="live-toggle" /> Live
          <select id="live-interval" style="font-size:12px;">
            <option value="15000">15s</option>
            <option value="30000" selected>30s</option>
            <option value="60000">60s</option>
          </select>
        </label>
        <label style="font-size:12px;display:flex;align-items:center;gap:6px;color:#163a6b;background:#fff;padding:4px 8px;border-radius:6px;">
          <input type="checkbox" id="pin-live" /> Pin live
        </label>
      </div>
    </div>
  <div class="muted" id="meta"></div>
  <div class="muted" id="wl-summary" style="margin-top:6px;"></div>
    <div class="muted" id="mtd-summary" style="margin-top:4px;"></div>
  </div>
  <div class="card">
    <h2 style="margin-top:0;">Projected Stats</h2>
  <div class="muted" style="margin-bottom:8px;">Season-average derived estimates with live Bovada lines (if available). Alt K ladder thresholds displayed.</div>
    <div class="table-wrap">
  <table id="proj-table" class="compact">
        <thead>
          <tr>
    <th>Pitcher</th><th>Team</th><th>Opp</th>
    <th title="Projected outs (raw model)">Outs</th><th title="Sportsbook line">Line</th><th>Rec</th>
    <th title="Projected strikeouts">K</th><th>Line (Odds)</th><th>Rec</th>
    <th class="col-adv" title="Alternate strikeout ladder thresholds">Alt K</th>
    <th class="col-adv" title="Projected earned runs">ER</th><th class="col-adv">Line</th><th class="col-adv">Rec</th>
    <th class="col-adv" title="Projected hits allowed">Hits</th><th class="col-adv">Line</th><th class="col-adv">Rec</th>
    <th class="col-adv" title="Projected walks">BB</th><th class="col-adv">Line</th><th class="col-adv">Rec</th>
    <th title="Data quality / reliability classification (HIGH=full context factors applied)">Conf</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<script>
let LIVE_TIMER = null;
window._liveMap = {};
window._liveTeams = new Set();
function todayISO(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function normalizeName(s){ try{ return s.normalize('NFD').replace(/\p{M}+/gu,'').toLowerCase().replace(/[^a-z0-9 ]+/g,'').trim(); }catch(_){ return (s||'').toLowerCase().trim(); } }
async function loadProjections(){
  const res = await fetch('/api/pitcher-projections');
  const js = await res.json();
  if(!js.success){ document.getElementById('meta').textContent = 'Error loading projections'; return; }
  const d = js.data;
  document.getElementById('meta').textContent = `Date ${d.date} • ${d.count} pitchers`;
    // Load month-to-date reconciliation summary once
    (async function loadMtd(){
      try{
        const d = new Date(); const month = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        const r = await fetch(`/api/pitcher-reconciliation/mtd?month=${month}&live=1`);
        const js = await r.json();
        if(js && js.success){
          const t = js.summary && js.summary.totals || {};
          const w = t.wins||0, l=t.losses||0, p=t.pushes||0, g=t.graded||0;
          const pct = g? ((w/g)*100).toFixed(0) : '0';
          const by = js.summary && js.summary.by_stat || {};
          function chip(k){ const s = by[k]||{}; const gg = s.graded||0; const pp = gg? ((s.wins||0)/gg*100).toFixed(0) : '0'; return `${k}: ${s.wins||0}-${s.losses||0}-${s.pushes||0} (${pp}%)`; }
          document.getElementById('mtd-summary').textContent = `MTD: ${w}-${l}-${p} (${pct}%) • ` + ['strikeouts','outs','earned_runs','hits_allowed','walks'].map(chip).join(' • ');
        }
      }catch(_){ /* ignore */ }
    })();
  const tbody = document.querySelector('#proj-table tbody');
  window._pitcherData = d.pitchers;
  renderRows();
  // kick off live if enabled
  setLive(document.getElementById('live-toggle').checked, true);
}
function altKTooltip(p){
  const alts = (p.lines.strikeouts_alts||[]);
  if(!alts.length) return '';
  const rows = alts.map(a=>`${a.threshold}+ (${a.odds>0?'+':''}${a.odds})`).join('\n');
  return rows;
}
function renderRows(){
  const tbody = document.querySelector('#proj-table tbody');
  if(!window._pitcherData){ tbody.innerHTML=''; return; }
  const hideNo = document.getElementById('toggle-nolines').checked;
  const sortKey = document.getElementById('sort-edge').value;
  let data = window._pitcherData.slice();
  if(hideNo){
    data = data.filter(p=> p.lines && Object.values(p.lines).some(v=>v && v.line!=null));
  }
  if(sortKey){
    data.sort((a,b)=>{ const da = Math.abs((a.diffs||{})[sortKey]||0); const db = Math.abs((b.diffs||{})[sortKey]||0); return db-da; });
  }
  const showAdv = document.getElementById('toggle-adv').checked;
  const cls = showAdv? '' : 'hide-adv';
  tbody.parentElement.parentElement.className = 'table-wrap '+cls;
  function getAct(name){ const k = normalizeName(name||''); const row = window._liveMap[k]; return row && row.act ? row.act : null; }
  function fmtAct(val, stat){ if(val==null||val===undefined) return ''; const prec = stat==='outs'?0:0; return ` <span class="muted" style="font-size:10px;">(Act ${prec?Number(val).toFixed(prec):val})</span>`; }
  // apply per-stat filter if selected
  const filterStat = (window._statFilter!=null ? window._statFilter : (document.getElementById('filter-stat')?.value || ''));
  if(filterStat){
    data = data.filter(p=>{
      const rec = (p.recommendations||{})[filterStat];
      const line = (((p.lines||{})[filterStat])||{}).line;
      return !!rec && line!=null;
    });
  }
  function recOutcome(p, stat){
    try{
      const k = normalizeName(p.pitcher_name||'');
      const rec = (p.recommendations||{})[stat];
      if(!rec) return null;
      const lineObj = (p.lines||{})[stat]||{}; const line = lineObj.line; if(line==null) return null;
      const liveRow = window._liveMap[k]; const act = liveRow && liveRow.act ? liveRow.act : null; if(!act) return null;
      const actualVal = stat==='outs' ? act.outs : (stat==='strikeouts'?act.k : (stat==='earned_runs'?act.er : (stat==='hits_allowed'?act.h : (stat==='walks'?act.bb : null))));
      if(actualVal==null) return null;
      if(rec==='OVER') return actualVal > line ? 'win' : (actualVal < line ? 'loss' : 'push');
      if(rec==='UNDER') return actualVal < line ? 'win' : (actualVal > line ? 'loss' : 'push');
      return null;
    }catch(_){ return null; }
  }
  // Pin and highlight live pitchers if enabled
  const pinLive = document.getElementById('pin-live')?.checked;
  if(pinLive && window._liveTeams && window._liveTeams.size){
    const liveFirst = [];
    const rest = [];
    data.forEach(p=>{ const isLive = window._liveTeams.has(normalizeName(p.team||'')); (isLive?liveFirst:rest).push(p); });
    data = liveFirst.concat(rest);
  }
  tbody.innerHTML = data.map(p=>{ const act = getAct(p.pitcher_name); const isLive = window._liveTeams.has(normalizeName(p.team||''));
    const outcomes = {
      outs: recOutcome(p,'outs'),
      strikeouts: recOutcome(p,'strikeouts'),
      earned_runs: recOutcome(p,'earned_runs'),
      hits_allowed: recOutcome(p,'hits_allowed'),
      walks: recOutcome(p,'walks')
    };
    const clsOuts = outcomes.outs==='win'?'rec-win':(outcomes.outs==='loss'?'rec-loss':'');
    const clsK = outcomes.strikeouts==='win'?'rec-win':(outcomes.strikeouts==='loss'?'rec-loss':'');
    const clsER = outcomes.earned_runs==='win'?'rec-win':(outcomes.earned_runs==='loss'?'rec-loss':'');
    const clsH = outcomes.hits_allowed==='win'?'rec-win':(outcomes.hits_allowed==='loss'?'rec-loss':'');
    const clsBB = outcomes.walks==='win'?'rec-win':(outcomes.walks==='loss'?'rec-loss':'');
    function badge(oc){ return oc==='win'?'✅':(oc==='loss'?'❌':(oc==='push'?'➖':'')); }
    return `<tr class="${isLive?'row-live':''}">
    <td>${p.pitcher_name}</td>
    <td>${p.team||''}</td>
    <td>${p.opponent||''}</td>
  <td>${p.projected_outs}${fmtAct(act?act.outs:null,'outs')}</td>
  <td>${formatLine(p.lines.outs)}</td>
  <td class="${edgeClass(p,'outs')} ${clsOuts}">${p.recommendations.outs??''}${edgeDiff(p,'outs')}</td>
    <td class="${edgeClass(p,'outs')} ${clsOuts}">${p.recommendations.outs??''}${edgeDiff(p,'outs')} <span class="muted" style="font-size:11px;">${badge(outcomes.outs)||''}</span></td>
  <td>${p.projected_strikeouts}${fmtAct(act?act.k:null,'k')}</td>
  <td>${formatLine(p.lines.strikeouts)}</td>
    <td class="${edgeClass(p,'strikeouts')} ${clsK}">${p.recommendations.strikeouts??''}${edgeDiff(p,'strikeouts')}</td>
      <td class="${edgeClass(p,'strikeouts')} ${clsK}">${p.recommendations.strikeouts??''}${edgeDiff(p,'strikeouts')} <span class="muted" style="font-size:11px;">${badge(outcomes.strikeouts)||''}</span></td>
    <td class="col-adv" title="${altKTooltip(p)}">${(p.lines.strikeouts_alts||p.strikeouts_alts||[]).map(a=>a.threshold).join(', ')}</td>
  <td class="col-adv">${p.projected_earned_runs}${fmtAct(act?act.er:null,'er')}</td>
  <td class="col-adv">${formatLine(p.lines.earned_runs)}</td>
  <td class="col-adv ${edgeClass(p,'earned_runs')} ${clsER}">${p.recommendations.earned_runs??''}${edgeDiff(p,'earned_runs')}</td>
    <td class="col-adv ${edgeClass(p,'earned_runs')} ${clsER}">${p.recommendations.earned_runs??''}${edgeDiff(p,'earned_runs')} <span class="muted" style="font-size:11px;">${badge(outcomes.earned_runs)||''}</span></td>
  <td class="col-adv">${p.projected_hits_allowed}${fmtAct(act?act.h:null,'h')}</td>
    <td class="col-adv">${formatLine(p.lines.hits_allowed)}</td>
    <td class="col-adv ${edgeClass(p,'hits_allowed')} ${clsH}">${p.recommendations.hits_allowed??''}${edgeDiff(p,'hits_allowed')}</td>
      <td class="col-adv ${edgeClass(p,'hits_allowed')} ${clsH}">${p.recommendations.hits_allowed??''}${edgeDiff(p,'hits_allowed')} <span class="muted" style="font-size:11px;">${badge(outcomes.hits_allowed)||''}</span></td>
  <td class="col-adv">${p.projected_walks??''}${fmtAct(act?act.bb:null,'bb')}</td>
  <td class="col-adv">${formatLine(p.lines.walks)}</td>
  <td class="col-adv ${edgeClass(p,'walks')} ${clsBB}">${p.recommendations.walks??''}${edgeDiff(p,'walks')}</td>
    <td class="col-adv ${edgeClass(p,'walks')} ${clsBB}">${p.recommendations.walks??''}${edgeDiff(p,'walks')} <span class="muted" style="font-size:11px;">${badge(outcomes.walks)||''}</span></td>
    <td><span class="badge ${p.confidence}">${p.confidence}</span></td>
  </tr>`}).join('');
}
function toggleAdvanced(){ renderRows(); }
async function fetchLive(){
  try{
    const d = todayISO();
    const [recRes, statusRes] = await Promise.all([
      fetch(`/api/pitcher-reconciliation?date=${d}&live=1`),
      fetch(`/api/live-status?date=${d}`)
    ]);
    const [js, ls] = await Promise.all([recRes.json(), statusRes.json()]);
    if(js && js.success){
      const map = {};
      (js.rows||[]).forEach(r=>{ if(r && r.pitcher_name){ map[normalizeName(r.pitcher_name)] = r; } });
      window._liveMap = map;
      // Update W/L/P summary chip
      const sum = js.summary && js.summary.totals;
      if(sum){
        const t = sum.graded||0, w = sum.wins||0, l = sum.losses||0, p = sum.pushes||0;
        const pct = t? ((w/t)*100).toFixed(0) : '0';
        document.getElementById('wl-summary').textContent = `Graded ${t}: W ${w} • L ${l} • P ${p} • Win% ${pct}%`;
      }
    }
    if(ls && ls.success){
      const teams = new Set();
      (ls.games||[]).forEach(g=>{ if(g && g.is_live){ teams.add(normalizeName(g.away_team||'')); teams.add(normalizeName(g.home_team||'')); } });
      window._liveTeams = teams;
    }
    // refresh rows with latest stats
    renderRows();
    // annotate meta with live timestamp (replace prior live time suffix)
    const meta = document.getElementById('meta');
    const base = meta.textContent.split(' • live ')[0];
    meta.textContent = `${base} • live ${new Date().toLocaleTimeString()}`;
  }catch(e){ /* ignore transient */ }
}
function setLive(enabled, immediate=false){
  const cb = document.getElementById('live-toggle'); if(cb) cb.checked = !!enabled;
  if(LIVE_TIMER){ clearInterval(LIVE_TIMER); LIVE_TIMER = null; }
  if(enabled){
    const iv = parseInt(document.getElementById('live-interval').value||'30000',10);
    if(immediate) fetchLive();
    LIVE_TIMER = setInterval(fetchLive, Math.max(5000, iv));
  }
}
document.getElementById('live-toggle').addEventListener('change', (e)=> setLive(e.target.checked, true));
document.getElementById('live-interval').addEventListener('change', ()=> setLive(document.getElementById('live-toggle').checked));
document.getElementById('pin-live').addEventListener('change', ()=> renderRows());
// Tabs wiring
(function setupTabs(){
  const box = document.getElementById('stat-tabs'); if(!box) return;
  box.addEventListener('click', (e)=>{
    const el = e.target.closest('.tab'); if(!el) return;
    const st = el.getAttribute('data-stat')||''; window._statFilter = st;
    Array.from(box.querySelectorAll('.tab')).forEach(t=> t.classList.toggle('active', t===el));
    // Mirror hidden dropdown value for fallback/debug
    const sel = document.getElementById('filter-stat'); if(sel){ sel.value = st; }
    renderRows();
  });
})();
loadProjections();
function formatLine(obj){
  if(!obj || obj.line==null) return '';
  const over = obj.over_odds!=null ? `O${obj.over_odds>0?'+':''}${obj.over_odds}` : '';
  const under = obj.under_odds!=null ? `U${obj.under_odds>0?'+':''}${obj.under_odds}` : '';
  return `${obj.line}${(over||under)?` (${over}${(over&&under?'/':'')}${under})`:''}`;
}
function edgeDiff(p, stat){
  if(!p.diffs || p.diffs[stat]==null) return '';
  const v = p.diffs[stat];
  const sign = v>0?'+':'';
  return ` <span style="font-size:10px;color:#555;">${sign}${stat==='outs'?v.toFixed(0):v.toFixed(1)}</span>`;
}
function edgeClass(p, stat){
  if(!p.recommendations || !p.recommendations[stat]) return '';
  const diff = p.diffs && p.diffs[stat]!=null ? Math.abs(p.diffs[stat]) : 0;
  const strong = (stat==='outs' && diff>=3) || (stat!=='outs' && diff>=1.2);
  if(p.recommendations[stat]==='OVER') return strong?'edge-pos edge-strong':'edge-pos';
  if(p.recommendations[stat]==='UNDER') return strong?'edge-neg edge-strong-neg':'edge-neg';
  return '';
}
function exportJSON(){
  fetch('/api/pitcher-projections').then(r=>r.json()).then(js=>{
    if(!js.success) return;
    const blob = new Blob([JSON.stringify(js.data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `pitcher_projections_${(js.data.date||'today')}.json`;
    document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove();}, 300);
  });
}
</script>
</body>
</html>
