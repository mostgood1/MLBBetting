<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Daily Pitcher Prop Recommendations</title>
<style>
 body { font-family: Inter, Arial, sans-serif; background:#0b1e39; margin:0; color:#111; }
 .container { max-width:1250px; margin:0 auto; padding:24px; }
 .card { background:#fff; border-radius:14px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.15); margin-bottom:18px; }
 h1 { color:#163a6b; margin:0 0 6px; }
 h2 { color:#163a6b; margin:0 0 10px; }
 table { width:100%; border-collapse:collapse; }
 th,td { padding:8px 10px; border-bottom:1px solid #eee; font-size:13px; text-align:left; }
 th { background:#f5f7fb; font-weight:600; }
 .muted { color:#555; font-size:12px; }
 .badge { padding:4px 8px; border-radius:999px; font-size:11px; font-weight:600; }
 .badge.HIGH { background:#16a34a; color:#fff; }
 .badge.MEDIUM { background:#2563eb; color:#fff; }
 .badge.LOW { background:#eab308; color:#111; }
 .pill { background:#163a6b; color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; text-decoration:none; display:inline-block; }
 .flex { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
 .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:14px; }
 .stat { background:#f8fbff; border:1px solid #e2ecf7; border-radius:12px; padding:14px; }
 .stat .num { font-size:24px; font-weight:700; color:#163a6b; }
 .ev-pos { color:#166534; font-weight:600; }
 .section-sep { border:0; border-top:1px solid #e5eaf1; margin:24px 0 12px; }
 .stake { font-weight:600; }
 .tabs { display:flex; gap:6px; flex-wrap:wrap; }
 .tab { cursor:pointer; border:1px solid #cfe1f8; color:#163a6b; background:#f8fbff; padding:6px 10px; border-radius:8px; font-size:12px; }
 .tab.active { background:#2563eb; color:#fff; border-color:#2563eb; }
 .tab .count { background:#e6eefb; color:#163a6b; border-radius:12px; padding:0 6px; margin-left:6px; font-weight:700; font-size:11px; }
 .tab.active .count { background:#fff; color:#2563eb; }
 @media (max-width:760px){ th,td { font-size:11px; padding:6px 6px; } h1 { font-size:22px; } }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="flex" style="justify-content:space-between;">
      <div>
  <h1>Daily Pitcher Prop Recommendations</h1>
        <div class="muted" id="meta">Loading...</div>
      </div>
      <div class="flex">
        <a href="/" class="pill">⬅ Main</a>
        <a href="/pitcher-projections" class="pill">Pitcher Projections</a>
        <a href="/betting-guidance" class="pill">Kelly Guidance</a>
      </div>
    </div>
  <div style="margin-top:8px;" class="muted">Stake sizing: HIGH $100 • MEDIUM $50 • LOW $25. Sorted by confidence then edge (projection vs line).</div>
  </div>

  <div class="card" id="summary-card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;">
      <div style="flex:1;min-width:260px;">
        <h2 style="margin-top:0;">Summary</h2>
        <div class="grid" id="summary-grid"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;min-width:340px;">
        <div class="flex" style="gap:6px;align-items:flex-start;">
          <label class="muted" style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" id="hide-low"/> Hide LOW</label>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <div class="muted" style="font-size:12px;">Stats</div>
            <div class="tabs" id="stat-tabs">
              <button class="tab" data-stat=""><span class="label">All</span><span class="count">0</span></button>
              <button class="tab" data-stat="strikeouts"><span class="label">K</span><span class="count">0</span></button>
              <button class="tab" data-stat="outs"><span class="label">Outs</span><span class="count">0</span></button>
              <button class="tab" data-stat="earned_runs"><span class="label">ER</span><span class="count">0</span></button>
              <button class="tab" data-stat="hits_allowed"><span class="label">Hits</span><span class="count">0</span></button>
              <button class="tab" data-stat="walks"><span class="label">BB</span><span class="count">0</span></button>
            </div>
          </div>
          <!-- Keep legacy select hidden for keyboard/compat, synced to tabs -->
          <label class="muted" style="display:none;align-items:center;gap:4px;font-size:12px;">
            Stat:
            <select id="stat-filter" style="padding:4px 6px;border-radius:6px;border:1px solid #cfe1f8;font-size:12px;">
              <option value="">All</option>
              <option value="strikeouts">Strikeouts</option>
              <option value="outs">Outs</option>
              <option value="earned_runs">Earned Runs</option>
              <option value="hits_allowed">Hits Allowed</option>
              <option value="walks">Walks</option>
            </select>
          </label>
        </div>
        <div class="flex" style="gap:6px;flex-wrap:wrap;">
          <input type="date" id="start-date" style="padding:4px 6px;border:1px solid #cfe1f8;border-radius:6px;font-size:12px;"/>
          <input type="date" id="end-date" style="padding:4px 6px;border:1px solid #cfe1f8;border-radius:6px;font-size:12px;"/>
          <button class="pill" style="background:#2563eb;" onclick="applyDateRange()">Range</button>
          <button class="pill" style="background:#0891b2;" onclick="loadCurrentMonth()">Month</button>
        </div>
        <div class="flex" style="gap:6px;">
          <input id="search" placeholder="Search pitcher/team" style="flex:1;padding:6px 8px;border:1px solid #cfe1f8;border-radius:6px;font-size:12px;"/>
          <button class="pill" onclick="reloadCurrent()">Reload</button>
          <label class="muted" style="display:flex;align-items:center;gap:6px;font-size:12px;">
            <input type="checkbox" id="live-toggle" /> Live
            <select id="live-interval" style="padding:4px 6px;border:1px solid #cfe1f8;border-radius:6px;font-size:12px;">
              <option value="15000">15s</option>
              <option value="30000" selected>30s</option>
              <option value="60000">60s</option>
            </select>
          </label>
        </div>
        <div class="flex" style="gap:6px;flex-wrap:wrap;">
          <a href="#" onclick="downloadJSON();return false;" class="pill" style="background:#2563eb;">JSON</a>
          <a href="#" onclick="downloadCSV();return false;" class="pill" style="background:#0891b2;">CSV</a>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Recommendations (Grouped)</h2>
    <div id="recs-grouped"></div>
  </div>

  <div class="card">
    <h2>All Pitcher Prop Plays</h2>
    <div class="table-wrap">
      <table id="recs-table">
        <thead>
          <tr>
            <th>Conf</th><th>Pitcher</th><th>Team</th><th>Opp</th><th>Stat</th><th>Line</th><th>Proj</th><th>Adj</th><th>Diff</th><th>Rec</th><th>Odds</th><th>Stake</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <!-- Audit modal removed for pitcher-only view -->
</div>
<script>
function fmtNum(v){
  if(v===null || v===undefined || v==='') return '';
  const n = Number(v);
  if(!isFinite(n)) return String(v);
  const s = n.toFixed(2);
  return s.replace(/\.00$/,'').replace(/(\.\d)0$/,'$1');
}
function fmtEV(n){ const v=Number(n); if(!isFinite(v)) return '-'; return (v*100).toFixed(1)+'%'; }
const STAKES = { HIGH:100, MEDIUM:50, LOW:25 };
let RAW_PROPS = [];
let LOAD_CONTEXT = { mode:'day', label:'Today', params:{} };
let LIVE_TIMER = null;
const STAT_KEYS = ['strikeouts','outs','earned_runs','hits_allowed','walks'];
const STAT_LABELS = { strikeouts:'K', outs:'Outs', earned_runs:'ER', hits_allowed:'Hits', walks:'BB' };
let ACTIVE_STAT = '';
function confRank(c){ return {HIGH:3, MEDIUM:2, LOW:1}[c]||0; }
function todayISO(){ const d=new Date(); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
// live control
function setLive(enabled){
  const cb = document.getElementById('live-toggle');
  if(cb) cb.checked = !!enabled;
  if(LIVE_TIMER){ clearInterval(LIVE_TIMER); LIVE_TIMER = null; }
  if(enabled && LOAD_CONTEXT.mode==='day'){
    const interval = parseInt(document.getElementById('live-interval').value||'30000',10);
    LIVE_TIMER = setInterval(()=>{
      // For day mode, explicitly pass today date to avoid month/range state bleed
      const d = todayISO();
      loadProps(`?date=${d}`);
    }, Math.max(5000, interval));
  }
}
function filterProps(){
  const hideLow = document.getElementById('hide-low').checked;
  // Prefer tab selection; fallback to hidden select for compatibility
  const statFilter = ACTIVE_STAT !== undefined ? ACTIVE_STAT : (document.getElementById('stat-filter')?.value || '');
  const q = document.getElementById('search').value.trim().toLowerCase();
  return RAW_PROPS.filter(p=>{
    if(hideLow && p.confidence==='LOW') return false;
    if(statFilter && p.stat!==statFilter) return false;
    if(q){
      const blob = `${p.pitcher_name} ${p.team} ${p.opponent} ${p.stat} ${p.recommendation}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
}
// Compute and render tab counts based on current filters except the stat itself
function updateTabCounts(){
  const hideLow = document.getElementById('hide-low').checked;
  const q = document.getElementById('search').value.trim().toLowerCase();
  const base = RAW_PROPS.filter(p=>{
    if(hideLow && p.confidence==='LOW') return false;
    if(q){
      const blob = `${p.pitcher_name} ${p.team} ${p.opponent} ${p.stat} ${p.recommendation}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
  const counts = { '': base.length };
  ['strikeouts','outs','earned_runs','hits_allowed','walks'].forEach(k=>{ counts[k] = base.filter(p=>p.stat===k).length; });
  document.querySelectorAll('#stat-tabs .tab').forEach(btn=>{
    const key = btn.getAttribute('data-stat')||'';
    const cval = counts[key]||0;
    const el = btn.querySelector('.count');
    if(el) el.textContent = String(cval);
  });
}
function setStatTab(stat){
  ACTIVE_STAT = stat || '';
  // Update tab UI states
  const tabs = document.querySelectorAll('#stat-tabs .tab');
  tabs.forEach(btn=>{
    const isActive = (btn.getAttribute('data-stat')||'') === ACTIVE_STAT;
    btn.classList.toggle('active', isActive);
  });
  // Sync hidden select for compatibility
  const sel = document.getElementById('stat-filter');
  if(sel){ sel.value = ACTIVE_STAT; }
  try { localStorage.setItem('props_active_stat', ACTIVE_STAT); } catch(_){}
  renderAll();
}
function renderAll(){
  const props = filterProps();
  document.getElementById('meta').textContent = `${LOAD_CONTEXT.label} • ${props.length} plays (raw ${RAW_PROPS.length})`;
  props.sort((a,b)=> confRank(b.confidence)-confRank(a.confidence) || (Math.abs(b.diff||0)-Math.abs(a.diff||0)) );
  const high = props.filter(p=>p.confidence==='HIGH');
  const med = props.filter(p=>p.confidence==='MEDIUM');
  const low = props.filter(p=>p.confidence==='LOW');
  const totalStake = high.length*STAKES.HIGH + med.length*STAKES.MEDIUM + low.length*STAKES.LOW;
  const sg = document.getElementById('summary-grid'); sg.innerHTML='';
  const blocks = [ ['High', high.length], ['Medium', med.length], ['Low', low.length], ['Total Plays', props.length], ['Total Stake', `$${totalStake}`] ];
  blocks.forEach(b=>{ const d=document.createElement('div'); d.className='stat'; d.innerHTML=`<div class='num'>${b[1]}</div><div class='muted'>${b[0]}</div>`; sg.appendChild(d); });
  // Grouped section
  const grouped = { HIGH: high, MEDIUM: med, LOW: low };
  const gdiv = document.getElementById('recs-grouped');
  gdiv.innerHTML = Object.keys(grouped).map(conf=>{
    const arr = grouped[conf];
    if(!arr.length) return `<div style='margin-bottom:12px;'><h3 style='margin:4px 0;'>${conf}</h3><div class='muted'>None</div></div>`;
    return `<div style='margin-bottom:18px;'>
      <h3 style='margin:4px 0;'>${conf} <span class='badge ${conf}' style='vertical-align:middle;'>${conf}</span> <span class='muted' style='font-weight:400;'>(${arr.length} plays • Stake $${STAKES[conf]})</span></h3>
      <table style='width:100%; border-collapse:collapse;'>
        <thead><tr><th>Pitcher</th><th>Stat</th><th>Line</th><th>Proj</th><th>Adj</th><th>Diff</th><th>Rec</th><th>Odds</th><th>EV</th><th>Stake</th></tr></thead>
        <tbody>
          ${arr.map(p=>`<tr>
            <td>${p.pitcher_name}</td>
            <td>${prettyStat(p.stat)}</td>
            <td>${formatLine(p)}</td>
            <td>${fmtVal(p.projection)}</td>
            <td>${fmtVal(p.adjusted_projection)}</td>
            <td>${fmtDiff(p.diff)}</td>
            <td>${p.recommendation}</td>
            <td>${p.odds_display||''}</td>
            <td>${fmtEV(p.expected_value)}</td>
            <td class='stake'>$${STAKES[conf]}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
  }).join('');
  // Full table
  const tbody = document.querySelector('#recs-table tbody');
  tbody.innerHTML = props.map(p=>`<tr>
    <td><span class='badge ${p.confidence}'>${p.confidence}</span></td>
    <td>${p.pitcher_name}</td>
    <td>${p.team||''}</td>
    <td>${p.opponent||''}</td>
    <td>${prettyStat(p.stat)}</td>
    <td>${formatLine(p)}</td>
    <td>${fmtVal(p.projection)}</td>
    <td>${fmtVal(p.adjusted_projection)}</td>
    <td>${fmtDiff(p.diff)}</td>
    <td>${p.recommendation}</td>
    <td>${p.odds_display||''}</td>
    <td>${fmtEV(p.expected_value)}</td>
    <td>$${STAKES[p.confidence]||0}</td>
  </tr>`).join('');
  updateTabCounts();
}
function fmtVal(v){ if(v==null) return ''; return fmtNum(v); }
function fmtDiff(d){ if(d==null) return ''; const sign = d>0?'+':''; return sign + fmtNum(Math.abs(Number(d))); }
function prettyStat(s){ return {strikeouts:'K', outs:'Outs', earned_runs:'ER', hits_allowed:'Hits', walks:'BB'}[s]||s; }
function formatLine(p){ if(p.line==null) return ''; return fmtNum(p.line); }
async function loadProps(qs=''){
  try{ const r = await fetch('/api/pitcher-prop-plays'+qs); const js = await r.json(); if(!js.success){ document.getElementById('meta').textContent='No data'; return; }
    let flat=[];
    if(js.mode==='aggregate'){
      flat = js.plays || [];
    } else {
      const plays = js.plays || {}; Object.keys(plays).forEach(stat=>{ const grp=plays[stat]; ['HIGH','MEDIUM','LOW'].forEach(conf=>{ (grp[conf]||[]).forEach(item=>{ flat.push(item); }); }); });
    }
    flat.forEach(item=>{ const odds = item.recommendation==='OVER'? item.over_odds : item.under_odds; item.odds_display = odds!=null ? (odds>0?`+${odds}`:odds) : ''; });
    RAW_PROPS = flat;
    // Update meta with snapshot timestamp when available for day mode
    if(LOAD_CONTEXT.mode==='day' && js.meta){
      const d = todayISO();
      const md = js.meta[d];
      if(md && md.generated_at){
        document.getElementById('meta').textContent = `Today (snapshot @ ${new Date(md.generated_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})})`;
      }
    }
    renderAll();
  } catch(e){ console.warn('loadProps failed', e); document.getElementById('meta').textContent='Error loading'; }
}
function loadToday(){
  const d = todayISO();
  LOAD_CONTEXT = { mode:'day', label:'Today (snapshot)', params:{date:d} };
  loadProps(`?date=${d}`);
}
function loadCurrentMonth(){
  const d=new Date(); const month = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  LOAD_CONTEXT = {mode:'month', label:`Month ${month}`, params:{month}};
  loadProps(`?month=${month}&aggregate=1`);
}
function applyDateRange(){
  const s=document.getElementById('start-date').value; const e=document.getElementById('end-date').value; if(!s||!e) return; LOAD_CONTEXT={mode:'range', label:`Range ${s} to ${e}`, params:{start:s,end:e}}; loadProps(`?start=${s}&end=${e}&aggregate=1`);
}
function reloadCurrent(){
  if(LOAD_CONTEXT.mode==='month') loadCurrentMonth();
  else if(LOAD_CONTEXT.mode==='range') applyDateRange();
  else { loadToday(); }
}
document.getElementById('hide-low').addEventListener('change', renderAll);
// Sync hidden select to tabs
document.getElementById('stat-filter').addEventListener('change', (e)=> setStatTab(e.target.value));
document.getElementById('search').addEventListener('input', function(){ clearTimeout(this._t); this._t=setTimeout(renderAll,200); });
document.getElementById('live-toggle').addEventListener('change', (e)=> setLive(e.target.checked));
document.getElementById('live-interval').addEventListener('change', ()=> setLive(document.getElementById('live-toggle').checked));
// Attach tab click handlers
document.querySelectorAll('#stat-tabs .tab').forEach(btn=>{
  btn.addEventListener('click', ()=> setStatTab(btn.getAttribute('data-stat')||''));
});
// Initialize default tab (remember last selection)
try{ const saved = localStorage.getItem('props_active_stat'); if(saved!==null){ ACTIVE_STAT = saved; } }catch(_){}
setStatTab(ACTIVE_STAT);
function downloadJSON(){ if(!RAW_PROPS.length) return; const blob=new Blob([JSON.stringify(RAW_PROPS,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pitcher_prop_recs_${todayISO()}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},300); }
function downloadCSV(){ if(!RAW_PROPS.length) return; const headers=['date','confidence','pitcher','team','opponent','stat','recommendation','line','projection','adjusted_projection','diff','odds','stake']; const lines=[headers.join(',')]; RAW_PROPS.forEach(p=>{ const stake=STAKES[p.confidence]||0; lines.push([todayISO(),p.confidence,p.pitcher_name,p.team,p.opponent,p.stat,p.recommendation,p.line,p.projection,p.adjusted_projection,p.diff,p.odds_display,stake].map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')); }); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`pitcher_prop_recs_${todayISO()}.csv`; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},300); }
// Default: load today's data and allow user to opt-in to live updates
loadToday();
</script>
</body>
</html>
